# Zero Sync Architecture

This document describes the core architecture of the Hominio application: frontend, API backend, authentication, and Zero sync engine.

## Architecture Overview

```
┌─────────────────┐         ┌──────────────┐         ┌──────────────┐
│   Frontend      │────────▶│  API Service │────────▶│ Zero Sync    │
│  (SvelteKit)    │  HTTP   │   (Elysia)   │  HTTP   │  (zero-cache)│
│  localhost:4202 │         │ localhost:4204│         │ localhost:4848│
└─────────────────┘         └──────────────┘         └──────────────┘
       │                            │                         │
       │                            │                         │
       └────────────────────────────┼─────────────────────────┘
                                    │
                           ┌────────▼────────┐
                           │   PostgreSQL   │
                           │  (Zero + Auth) │
                           └─────────────────┘
```

## Core Components

### 1. Frontend (`services/app`)
- **Framework**: SvelteKit
- **Port**: `4202`
- **Key Routes**:
  - `/me` - Projects list (default after login)
  - `/signin` - Authentication
- **Data Fetching**:
  - Connects **directly** to Zero sync service (`localhost:4848`) for real-time data
  - Uses Zero client (`@rocicorp/zero`) for synced queries and mutators
  - Fetches initial data from API (`/api/v0/projects`) for non-Zero endpoints
- **Zero Client**: Uses `zero.materialize()` for reactive queries, `zero.mutate.*` for mutations

### 2. API Backend (`services/api`)
- **Framework**: Elysia.js (Bun runtime)
- **Port**: `4204`
- **API Version**: `v0` (not `v1`)
- **Key Endpoints**:
  - `GET /api/v0/projects` - Returns project list from Zero database
  - `POST /api/v0/zero/get-queries` - Server-side Zero synced queries
  - `POST /api/v0/zero/push` - Server-side Zero custom mutators
  - `GET /health` - Health check
- **CORS**: Manual CORS header handling (like hominio-me)
  - Checks `isTrustedOrigin()` for each request
  - Sets `Access-Control-Allow-Origin`, `Access-Control-Allow-Credentials: true`
  - Handles OPTIONS preflight requests
- **Database**: Uses Zero Postgres (`ZERO_POSTGRES_SECRET`) for queries

### 3. Zero Sync Service (`services/sync`)
- **Service**: `zero-cache-dev` (Rocicorp Zero sync engine)
- **Port**: `4848` (internal), exposed via `4203` (external)
- **Schema**: `zero-schema.ts` defines all synced tables
- **Database**: PostgreSQL (`ZERO_POSTGRES_SECRET`) - **must be non-pooler connection**
- **Auto-Migration**: Runs `zero-migrate.js` on startup before starting `zero-cache-dev`
  - Creates all tables, sets up replication, adds example project if empty
- **Endpoints** (configured via env vars):
  - `ZERO_GET_QUERIES_URL`: `http://localhost:4204/api/v0/zero/get-queries`
  - `ZERO_PUSH_URL`: `http://localhost:4204/api/v0/zero/push`
- **Cookie Forwarding**: Enabled (`--get-queries-forward-cookies`, `--mutate-forward-cookies`)

### 4. Authentication (`services/wallet` - Auth Layer)
- **Framework**: Better Auth
- **Port**: `4201` (wallet service)
- **Responsibility**: **ONLY service that handles authentication**
  - User sign up / sign in
  - Session creation
  - Cookie setting
  - OAuth providers (Google, etc.)
  - Account management
  - All `/api/auth/*` routes
- **Shared Secret**: `AUTH_SECRET` (must be same across wallet, api, sync services)
- **Database**: `AUTH_POSTGRES_SECRET` (Better Auth user/session data)
- **Cookie-Based**: Uses HTTP-only cookies for session management
- **Cross-Subdomain**: Cookies shared across `localhost:4201`, `localhost:4202`, `localhost:4204`

### 5. API Service Cookie Verification (Read-Only)
- **⚠️ IMPORTANT**: API service does NOT handle authentication
- **Read-Only**: Only verifies cookies set by wallet service
- **Minimal Better Auth Instance**: Used ONLY for `auth.api.getSession()` to verify cookie signatures
- **No Auth Routes**: API service does NOT mount `/api/auth/*` routes (wallet handles those)
- **No Cookie Setting**: API service does NOT set cookies (wallet sets cookies)
- **Purpose**: Extract auth data from cookies for authorization checks in Zero endpoints and API routes

## Data Flow

### Reading Data (Synced Queries)
1. Frontend calls `zero.materialize(query)` → connects to Zero sync service
2. Zero sync checks local cache → if missing, calls API `/api/v0/zero/get-queries`
3. API **verifies cookies** (set by wallet service) → extracts auth → executes server-side query → returns data
4. Zero sync caches data → streams to frontend
5. Frontend reactively updates when data changes

### Writing Data (Custom Mutators)
1. Frontend calls `zero.mutate.*()` → runs optimistically on client
2. Zero sync forwards mutation to API `/api/v0/zero/push` (with cookies from wallet service)
3. API **verifies cookies** (set by wallet service) → validates permissions → executes server mutator
4. Server mutator writes to Postgres → Zero sync detects change via logical replication
5. Zero sync streams update to all connected clients

### Non-Zero Endpoints
- Frontend fetches directly from API (e.g., `GET /api/v0/projects`)
- API queries Postgres directly → returns JSON
- Used for endpoints that don't need real-time sync

## Key Architecture Principles

### 1. Client Connects Directly to Zero Sync
- **Frontend NEVER connects to API for Zero data**
- Frontend connects to Zero sync service (`localhost:4848`) for all synced queries/mutators
- API and Zero sync handle backend coordination internally

### 2. Cookie-Based Authentication (Wallet Service Only)
- **Wallet service** (`services/wallet`) is the ONLY service that handles authentication
  - Sets cookies, creates sessions, handles OAuth, manages accounts
- **API service** only verifies cookies (read-only) - does NOT handle auth routes
- **Zero sync** forwards cookies to API endpoints for verification
- Better Auth cookies shared across all services via `AUTH_SECRET` (must be identical)
- Cookies forwarded automatically by Zero sync to API endpoints

### 3. Manual CORS Handling
- **No CORS plugin** for `/api/v0/*` routes (causes header duplication)
- Manual header setting using `isTrustedOrigin()` check
- Returns `Response` objects directly (not Elysia context) to avoid header duplication

### 4. Database Separation
- **Zero Database**: `ZERO_POSTGRES_SECRET` - synced data (projects, notifications, etc.)
- **Auth Database**: `AUTH_POSTGRES_SECRET` - Better Auth sessions/users
- Can be same database or separate (recommended: separate for production)

### 5. Auto-Migration on Startup
- Sync service runs migrations before starting `zero-cache-dev`
- Ensures schema is always up-to-date
- Adds example project if table is empty

## Environment Variables

### Required
- `ZERO_POSTGRES_SECRET` - Zero database (non-pooler connection)
- `AUTH_POSTGRES_SECRET` - Better Auth database
- `AUTH_SECRET` - Shared secret (same across wallet, api, sync)

### Optional
- `PUBLIC_DOMAIN_API` - API domain (defaults to `localhost:4204`)
- `PUBLIC_DOMAIN_SYNC` - Zero sync domain (defaults to `localhost:4203`)
- `ZERO_GET_QUERIES_URL` - Override get-queries endpoint
- `ZERO_PUSH_URL` - Override push endpoint

## Development Workflow

1. **Start all services**: `bun dev` (runs website, wallet, app, api, sync)
2. **Wallet service**: Handles all authentication (sign in, cookies, sessions)
3. **Sync service**: Auto-runs migrations → starts `zero-cache-dev`
4. **API service**: Starts Elysia server → verifies cookies (read-only) → handles Zero endpoints
5. **Frontend**: Connects to Zero sync → fetches projects → displays in UI

## File Structure

```
services/
├── app/              # SvelteKit frontend
│   └── src/routes/me/+page.svelte  # Projects list
├── api/              # Elysia API backend
│   ├── src/index.ts  # Main server
│   └── src/routes/v0/
│       ├── projects.ts           # Projects endpoint
│       └── zero/
│           ├── get-queries.ts    # Zero synced queries
│           └── push.ts           # Zero custom mutators
└── sync/             # Zero sync service
    ├── zero-schema.ts            # Zero schema definition
    └── scripts/
        ├── dev.js                # Dev script (runs migration + zero-cache-dev)
        └── zero-migrate.js       # Database migration + example project
```

## Important Notes

- **Zero sync requires non-pooler Postgres connection** (logical replication needs direct connection)
- **CORS headers must be set manually** (Elysia CORS plugin causes duplication)
- **AUTH_SECRET must match** across all services for cookie sharing
- **Frontend only connects to Zero sync** - API handles backend coordination
- **API version is v0** (not v1) - all endpoints under `/api/v0/*`
- **⚠️ Separation of Concerns**:
  - **Wallet service** (`services/wallet`): Handles ALL authentication (sign in, sign up, cookies, OAuth, account management)
  - **API service** (`services/api`): ONLY verifies cookies (read-only) - does NOT handle auth routes
  - **Zero sync** (`services/sync`): Forwards cookies to API for verification
